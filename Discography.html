<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tenshi — Discography</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root { color-scheme: dark; }
  *{ box-sizing:border-box }
  body{ margin:0; background:#0b0b0b; color:#eee; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
  a{ color:inherit; text-decoration:none }

  .hero{ max-width:1400px; margin:48px auto 10px; padding:0 16px; text-align:center }
  .title{ font-size:34px; font-weight:900; margin:16px 0 4px }
  .subtitle{ opacity:.7; font-size:12px; letter-spacing:.25em }

  .filters{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:16px auto 26px }
  .chip{ border:1px solid #2a2a2a; background:#121212; color:#dfe6eb; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer }
  .chip.active{ border-color:#ffcc70; color:#111; background:#ffcc70 }

  /* ========= GRILLA MÁS COMPACTA ========= */
  .grid{
    max-width:1500px; margin:0 auto 80px; padding:0 16px;
    display:grid; gap:20px 18px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
  /* en pantallas grandes, fuerza aún más columnas */
  @media (min-width:1280px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
  @media (min-width:1600px){ .grid{ grid-template-columns: repeat(5, 1fr); } }

  .card{ background:#111; border:1px solid #222; border-radius:12px; overflow:hidden;
         box-shadow:0 16px 36px rgba(0,0,0,.45); transition:.15s; cursor:pointer }
  .card:hover{ transform:translateY(-2px); box-shadow:0 22px 50px rgba(0,0,0,.6) }
  .thumb{ width:100%; aspect-ratio:1/1; background:#0e0e0e center/cover no-repeat }
  .meta{ padding:8px 10px 10px; text-align:center }
  .name{ font-size:12px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

  /* ===== MODAL full-screen y hard-lock ===== */
  .modal{ position:fixed; inset:0; display:none; place-items:center; background:#000; z-index:9999; padding:8px }
  .modal.open{ display:grid }
  .sheet{
    width:98vw; height:98vh;
    background:#0f0f0f; border:1px solid #222; border-radius:18px;
    box-shadow:0 60px 150px rgba(0,0,0,.95); overflow:hidden; animation:pop .12s ease-out
  }
  @keyframes pop{ from{ transform:scale(.985); opacity:.96 } to{ transform:scale(1); opacity:1 } }
  .sheet-head{ display:flex; align-items:center; justify-content:space-between;
               padding:16px 20px; border-bottom:1px solid #202020; background:#111; position:sticky; top:0; z-index:2 }
  .sheet-title{ font-weight:900; font-size:20px }
  .close{ border:none; border-radius:10px; background:#222; color:#eee; padding:8px 12px; cursor:pointer; font-weight:800 }
  .close:hover{ background:#333 }

  /* layout: portada izq / player der */
  .sheet-body{
    display:grid; grid-template-columns:.45fr 1.55fr; gap:30px; padding:24px;
    overflow:auto; height:calc(98vh - 66px)
  }
  @media (max-width:1100px){ .sheet-body{ grid-template-columns:1fr } }

  .cover{
    width:100%; max-width:360px; aspect-ratio:1/1;
    border-radius:14px; border:1px solid #222; background:#0d0d0d center/cover no-repeat;
    margin:0 auto 16px
  }

  /* plataformas GRANDES */
  .platforms{ display:flex; flex-wrap:wrap; gap:16px; justify-content:center }
  .platforms a, .platforms span{
    display:inline-flex; align-items:center; justify-content:center;
    width:70px; height:70px; border-radius:16px; background:#151515; border:1px solid #222
  }
  .platforms a{ transition:transform .15s ease, background .2s ease, border-color .2s ease }
  .platforms a:hover{ transform:translateY(-1px); background:#1d1d1d; border-color:#333 }
  .platforms i{ font-size:30px; opacity:.95 }
  .platforms .off{ opacity:.35; filter:grayscale(1) }

  /* Player contenedor (derecha) */
  .player{ display:flex; flex-direction:column; gap:16px; min-height:260px }
  .p-title{ font-weight:900; font-size:22px }
  .p-artist{ opacity:.75; font-size:12px; margin-top:-8px }

  /* ===== Estilo embed Spotify ===== */
  .spotify-embed{
    position: relative;
    border: 1px solid #222;
    border-radius: 16px;
    background:#0f0f0f;
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    overflow: hidden;                 /* recorte */
  }
  .spotify-embed iframe{
    display:block;
    width:100%;
    height:152px;                     /* compacto (track) */
    border:0;
  }
  /* oculta visualmente la mini carátula del embed */
  .spotify-embed.no-cover{ --coverW:132px; }
  .spotify-embed.no-cover iframe{
    width: calc(100% + var(--coverW));
    transform: translateX(calc(var(--coverW) * -1));
  }
  @media (max-width:520px){
    .spotify-embed.no-cover iframe{ width:100%; transform:none; }
  }

  body.hardmodal-open{ overflow:hidden }
</style>
</head>
<body>

<header class="hero">
  <div class="title">DISCOGRAPHY</div>
  <div class="subtitle">ディスコグラフィー</div>
</header>

<nav class="filters" id="filters">
  <button class="chip active" data-type="all">ALL</button>
  <button class="chip" data-type="single">SINGLE</button>
  <button class="chip" data-type="ep">EP</button>
  <button class="chip" data-type="album">ALBUM</button>
</nav>

<main class="grid" id="grid"></main>

<!-- MODAL -->
<div class="modal" id="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="sheet-head">
      <div class="sheet-title" id="mTitle">Track</div>
      <button class="close" id="btnClose" aria-label="Cerrar">✕</button>
    </div>

    <div class="sheet-body">
      <div>
        <div class="cover" id="mCover"></div>
        <div class="platforms" id="mPlatforms"></div>
      </div>

      <div class="player">
        <div class="p-title" id="pTitle">—</div>
        <div class="p-artist">J-Tenshi</div>

        <!-- Embed de Spotify SIN carátula (recortada/oculta) -->
        <div class="spotify-embed no-cover">
          <iframe id="spotifyFrame"
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy"></iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== CARGA DESDE data/songs.json ====== */
let ITEMS = [];
async function loadItems(){
  try{
    const r = await fetch('data/songs.json', {cache:'no-store'});
    const arr = await r.json();
    ITEMS = (Array.isArray(arr)?arr:[]).map(x=>({
      spotify:x.spotify, apple:x.apple||"", youtube:x.youtube||"", deezer:x.deezer||"", amazon:x.amazon||"", tidal:x.tidal||"",
      title:x.title||"", cover:x.cover||"", type:x.type||"single"
    })).filter(x=>!!x.spotify);
  }catch{ ITEMS=[]; }
}

/* ====== HELPERS ====== */
const grid=document.getElementById('grid');
const filters=document.getElementById('filters');
const modal=document.getElementById('modal');
const mTitle=document.getElementById('mTitle');
const mCover=document.getElementById('mCover');
const mPlatforms=document.getElementById('mPlatforms');
const pTitle=document.getElementById('pTitle');
const iframe=document.getElementById('spotifyFrame');
const btnClose=document.getElementById('btnClose');

const HARD_LOCK={
  onKeydown(e){ if(e.key==='Escape'){ e.preventDefault(); e.stopPropagation(); } },
  onDocClick(e){ const s=document.querySelector('.sheet'); if(s && !s.contains(e.target)){ e.stopPropagation(); e.preventDefault(); } },
  enable(){ document.body.classList.add('hardmodal-open'); document.addEventListener('keydown',this.onKeydown,true); document.addEventListener('click',this.onDocClick,true); modal.addEventListener('click',e=>e.stopPropagation(),true); modal.setAttribute('aria-hidden','false'); },
  disable(){ document.body.classList.remove('hardmodal-open'); document.removeEventListener('keydown',this.onKeydown,true); document.removeEventListener('click',this.onDocClick,true); modal.setAttribute('aria-hidden','true'); }
};
document.addEventListener('click',(e)=>{ const b=e.target.closest('#btnClose,.close'); if(!b) return; e.preventDefault(); e.stopImmediatePropagation(); closeModal(); }, true);

let currentType='all';

/* completa cover/title con oEmbed si faltan */
async function hydrateFromOEmbed(item){
  try{
    const url=`https://open.spotify.com/oembed?url=${encodeURIComponent(item.spotify)}&maxwidth=640`;
    const res=await fetch(url,{cache:'no-store'});
    if(res.ok){ const d=await res.json(); if(!item.cover&&d.thumbnail_url)item.cover=d.thumbnail_url; if(!item.title&&d.title)item.title=d.title; }
  }catch{}
}
async function hydrateAll(items){ await Promise.allSettled(items.map(hydrateFromOEmbed)); }

/* grid */
function render(){
  grid.innerHTML='';
  const list=ITEMS.filter(it=>currentType==='all'?true:it.type===currentType);
  if(!list.length){ grid.innerHTML=`<div style="grid-column:1/-1;opacity:.7;text-align:center;padding:32px">No hay canciones.</div>`; return; }
  list.forEach(it=>{
    const card=document.createElement('div'); card.className='card';
    const cover=it.cover||'https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=800&auto=format&fit=crop';
    const name=it.title||'Track';
    card.innerHTML=`<div class="thumb" style="background-image:url('${cover}')"></div><div class="meta"><div class="name" title="${name}">${name}</div></div>`;
    card.addEventListener('click',()=>openModal(it));
    grid.appendChild(card);
  });
}
filters.addEventListener('click',(e)=>{ const b=e.target.closest('.chip'); if(!b)return;
  filters.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  b.classList.add('active'); currentType=b.dataset.type||'all'; render();
});

/* plataformas */
function renderPlatformsFor(item){
  const cell=(href,icon,title,style)=> href
    ? `<a href="${href}" target="_blank" rel="noopener" title="${title}"><i class="${icon}" style="${style}"></i></a>`
    : `<span class="off" title="${title} (pronto)"><i class="${icon}" style="${style}"></i></span>`;
  mPlatforms.innerHTML=[
    cell(item.spotify,'fa-brands fa-spotify','Spotify','color:#1DB954;'),
    cell(item.apple,'fa-brands fa-apple','Apple Music','color:#fff;'),
    cell(item.youtube,'fa-brands fa-youtube','YouTube','color:#FF0000;'),
    cell(item.deezer,'fa-brands fa-deezer','Deezer','color:#ccc;'),
    cell(item.amazon,'fa-brands fa-amazon','Amazon Music','color:#FF9900;'),
    cell(item.tidal,'fa-solid fa-music','Tidal','color:#00ffff;')
  ].join('');
}

function trackId(url){ const m=String(url).match(/^https?:\/\/open\.spotify\.com\/(?:intl-[^/]+\/)?track\/([A-Za-z0-9]+)(?:\?.*)?$/); return m?m[1]:null; }

/* modal */
function openModal(item){
  const id=trackId(item.spotify||'');
  mTitle.textContent=item.title||'Track';
  pTitle.textContent=item.title||'Track';
  mCover.style.backgroundImage=`url('${item.cover||''}')`;
  renderPlatformsFor(item);

  iframe.src = id
    ? `https://open.spotify.com/embed/track/${id}?utm_source=generator&theme=0`
    : 'about:blank';

  modal.classList.add('open'); HARD_LOCK.enable();
}
function closeModal(){ modal.classList.remove('open'); HARD_LOCK.disable(); iframe.src='about:blank'; }

/* init */
(async()=>{ await loadItems(); await hydrateAll(ITEMS); render(); })();
</script>
</body>
</html>
