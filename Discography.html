<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tenshi — Discography</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root { color-scheme: dark; }
  *{box-sizing:border-box}
  body{
    margin:0; background:#0b0b0b; color:#eee;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  a{ color:inherit; text-decoration:none; }

  .hero{
    max-width:980px; margin:48px auto 10px; padding:0 16px; text-align:center;
  }
  .title{ font-size:34px; font-weight:900; letter-spacing:.5px; margin:16px 0 4px; }
  .subtitle{ opacity:.7; font-size:12px; letter-spacing:.25em; }

  .filters{
    display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
    margin:16px auto 26px;
  }
  .chip{
    border:1px solid #2a2a2a; background:#121212; color:#dfe6eb;
    padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
  }
  .chip.active{ border-color:#ffcc70; color:#111; background:#ffcc70; }

  .grid{
    max-width:1200px; margin:0 auto 80px; padding:0 16px;
    display:grid; grid-template-columns: repeat(3, 1fr); gap:28px 24px;
  }
  @media (max-width:1100px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:640px){ .grid{ grid-template-columns: 1fr; } }

  .card{
    background:#111; border:1px solid #222; border-radius:12px; overflow:hidden;
    box-shadow:0 16px 36px rgba(0,0,0,.45);
    transition:transform .15s ease, box-shadow .15s ease;
    cursor:pointer;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 22px 50px rgba(0,0,0,.6); }
  .thumb{ width:100%; aspect-ratio:1/1; background:#0e0e0e center/cover no-repeat; }
  .meta{ padding:10px 12px 12px; text-align:center; }
  .name{ font-size:13px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* ===== MODAL grande + hard-lock ===== */
  .modal{
    position:fixed; inset:0; display:none; place-items:center;
    background:#000; z-index:9999; padding:8px;
  }
  .modal.open{ display:grid; }

  .sheet{
    width:min(1500px, 98vw);
    max-height:96vh;
    background:#0f0f0f; border:1px solid #222; border-radius:16px;
    box-shadow:0 40px 120px rgba(0,0,0,.9);
    overflow:hidden;
    animation:pop .12s ease-out;
  }
  @keyframes pop { from{ transform:scale(.985); opacity:.96 } to{ transform:scale(1); opacity:1 } }

  .sheet-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 18px; border-bottom:1px solid #202020; background:#111;
    position:sticky; top:0; z-index:2;
  }
  .sheet-title{ font-weight:900; font-size:18px }
  .close{ border:none; border-radius:10px; background:#222; color:#eee; padding:8px 12px; cursor:pointer; font-weight:800; }
  .close:hover{ background:#333; }

  /* Layout: portada más chica a la izquierda, player amplio a la derecha */
  .sheet-body{
    display:grid; grid-template-columns: 0.65fr 1.35fr; gap:22px; padding:20px;
    overflow:auto; max-height:calc(96vh - 62px);
  }
  @media (max-width:1100px){ .sheet-body{ grid-template-columns: 1fr; } }

  .cover{
    width:100%; max-width:420px; aspect-ratio:1/1; border-radius:12px; border:1px solid #222;
    background:#0d0d0d center/cover no-repeat; margin:0 auto;
  }

  /* Plataformas: MÁS GRANDES (52px) — apagadas si no hay link */
  .platforms{
    display:flex; flex-wrap:wrap; gap:12px; margin-top:14px; justify-content:center;
  }
  .platforms a, .platforms span{
    display:inline-flex; align-items:center; justify-content:center;
    width:52px; height:52px; border-radius:12px; background:#151515; border:1px solid #222;
  }
  .platforms a{ transition:transform .15s ease, background .2s ease, border-color .2s ease; }
  .platforms a:hover{ transform:translateY(-1px); background:#1d1d1d; border-color:#333; }
  .platforms i{ font-size:24px; opacity:.95; }
  .platforms .off{ opacity:.35; filter:grayscale(1); }

  .player{
    background:#111; border:1px solid #222; border-radius:14px; padding:18px;
    display:flex; flex-direction:column; gap:16px;
  }
  .p-title{ font-weight:900; font-size:20px; }
  .p-artist{ opacity:.7; font-size:12px; margin-top:-8px; }

  .p-controls{ display:flex; align-items:center; gap:14px; }
  .p-btn{
    width:48px; height:48px; border-radius:50%; border:1px solid #333; background:#222; color:#eee; cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center; font-size:18px;
  }
  .p-btn:hover{ background:#2b2b2b; }

  .p-bar{
    position:relative; flex:1; height:10px; background:#1a1a1a; border-radius:999px; overflow:hidden; border:1px solid #222;
  }
  .p-bar > span{ position:absolute; left:0; top:0; bottom:0; width:0%; background:#ffcc70; }

  .p-time{ width:64px; text-align:right; font-variant-numeric: tabular-nums; opacity:.85; font-size:12px; }

  .p-note{ font-size:12px; opacity:.7; }

  body.hardmodal-open{ overflow:hidden; }
</style>
</head>
<body>

  <header class="hero">
    <div class="title">DISCOGRAPHY</div>
    <div class="subtitle">ディスコグラフィー</div>
  </header>

  <nav class="filters" id="filters">
    <button class="chip active" data-type="all">ALL</button>
    <button class="chip" data-type="single">SINGLE</button>
    <button class="chip" data-type="ep">EP</button>
    <button class="chip" data-type="album">ALBUM</button>
  </nav>

  <main class="grid" id="grid"></main>

  <!-- Modal -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="mTitle">
      <div class="sheet-head">
        <div class="sheet-title" id="mTitle">Track</div>
        <button class="close" id="btnClose" aria-label="Cerrar">✕</button>
      </div>
      <div class="sheet-body">
        <div>
          <div class="cover" id="mCover"></div>
          <div class="platforms" id="mPlatforms"></div>
        </div>
        <div class="player">
          <div class="p-title" id="pTitle">—</div>
          <div class="p-artist" id="pArtist">J-Tenshi</div>

          <div class="p-controls">
            <button class="p-btn" id="btnPlay"><i class="fa-solid fa-play"></i></button>
            <div class="p-bar" id="bar"><span></span></div>
            <div class="p-time" id="pTime">0:00</div>
          </div>

          <div class="p-note" id="pNote">Sin preview. Agrega “preview” (mp3/ogg) en <code>data/songs.json</code> para usar el reproductor.</div>
          <audio id="audio" preload="none"></audio>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= CARGA DESDE data/songs.json ========= */
let ITEMS = [];

async function loadItems() {
  try {
    const r = await fetch('data/songs.json', { cache: 'no-store' });
    if (!r.ok) throw new Error('songs.json no disponible');
    const arr = await r.json();
    ITEMS = (Array.isArray(arr) ? arr : [])
      .map(x => ({
        spotify: x.spotify,
        apple:   x.apple   || "",
        youtube: x.youtube || "",
        deezer:  x.deezer  || "",
        amazon:  x.amazon  || "",
        tidal:   x.tidal   || "",
        preview: x.preview || "", // MP3/OGG opcional para el player propio
        title:   x.title   || "",
        cover:   x.cover   || "",
        type:    x.type    || "single"
      }))
      .filter(x => !!x.spotify);
  } catch (e) {
    console.error('Error cargando songs.json:', e);
    ITEMS = [];
  }
}

/* ========= Helpers ========= */
const grid    = document.getElementById('grid');
const filters = document.getElementById('filters');
const modal   = document.getElementById('modal');
const mTitle  = document.getElementById('mTitle');
const mCover  = document.getElementById('mCover');
const mPlatforms = document.getElementById('mPlatforms');

const pTitle  = document.getElementById('pTitle');
const pArtist = document.getElementById('pArtist');
const pNote   = document.getElementById('pNote');
const btnPlay = document.getElementById('btnPlay');
const audioEl = document.getElementById('audio');
const bar     = document.getElementById('bar');
const barFill = bar.querySelector('span');
const pTime   = document.getElementById('pTime');

const btnClose = document.getElementById('btnClose');

/* HARD-LOCK: sin click-fuera, sin ESC, body sin scroll */
const HARD_LOCK = {
  onKeydown(e){
    if(e.key === 'Escape'){
      e.preventDefault();
      e.stopPropagation();
    }
  },
  onDocClick(e){
    const sheet = modal.querySelector('.sheet');
    if (sheet && !sheet.contains(e.target)) {
      e.stopPropagation();
      e.preventDefault();
    }
  },
  enable(){
    document.body.classList.add('hardmodal-open');
    document.addEventListener('keydown', HARD_LOCK.onKeydown, true);
    document.addEventListener('click',   HARD_LOCK.onDocClick, true);
    modal.addEventListener('click', e => e.stopPropagation(), true);
    modal.setAttribute('aria-hidden','false');
  },
  disable(){
    document.body.classList.remove('hardmodal-open');
    document.removeEventListener('keydown', HARD_LOCK.onKeydown, true);
    document.removeEventListener('click',   HARD_LOCK.onDocClick, true);
    modal.setAttribute('aria-hidden','true');
  }
};

/* FIX CRUZ — cierre garantizado, prioridad máxima */
document.addEventListener('click', function(e){
  const btn = e.target.closest('#btnClose, .close, [data-close], [aria-label="Cerrar"]');
  if (!btn) return;
  e.preventDefault();
  e.stopImmediatePropagation();
  closeModal();
}, true);

document.addEventListener('keydown', function(e){
  const el = document.activeElement;
  if (!el || !(el.matches && el.matches('#btnClose, .close, [data-close], [aria-label="Cerrar"]'))) return;
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    e.stopImmediatePropagation();
    closeModal();
  }
}, true);

let currentType = 'all';

/* === oEmbed para carátula y título (sin token) === */
async function hydrateFromOEmbed(item){
  if(!item.spotify) return item;
  const url = encodeURIComponent(item.spotify);
  const oembedURL = `https://open.spotify.com/oembed?url=${url}&maxwidth=640`;
  try{
    const res = await fetch(oembedURL, { mode: 'cors', cache:'no-store' });
    if(!res.ok) throw new Error('oEmbed error');
    const data = await res.json();
    if(!item.cover && data.thumbnail_url) item.cover = data.thumbnail_url;
    if(!item.title && data.title) item.title = data.title;
  }catch(e){ /* seguimos */ }
  return item;
}

async function hydrateAll(items){
  const jobs = items.map(it => hydrateFromOEmbed(it));
  await Promise.allSettled(jobs);
}

/* === Cards (sin fechas) === */
function render(){
  grid.innerHTML = '';
  const list = ITEMS.filter(it => currentType==='all' ? true : it.type===currentType);
  if (!list.length) {
    grid.innerHTML = `<div style="grid-column:1/-1; opacity:.7; text-align:center; padding:32px;">No hay canciones en esta vista.</div>`;
    return;
  }
  list.forEach((it) => {
    const card = document.createElement('div');
    card.className = 'card';
    const cover = it.cover || 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=800&auto=format&fit=crop';
    const name  = it.title || 'Track';
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${cover}')"></div>
      <div class="meta"><div class="name" title="${name}">${name}</div></div>
    `;
    card.addEventListener('click', () => openModal(it));
    grid.appendChild(card);
  });
}

filters.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip'); if(!btn) return;
  filters.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  currentType = btn.dataset.type || 'all';
  render();
});

/* === Plataformas (siempre visibles) === */
function renderPlatformsFor(item){
  const tpl = (href, icon, title, style) => href
    ? `<a href="${href}" target="_blank" rel="noopener noreferrer" title="${title}"><i class="${icon}" style="${style}"></i></a>`
    : `<span class="off" title="${title} (pronto)"><i class="${icon}" style="${style}"></i></span>`;

  mPlatforms.innerHTML = [
    tpl(item.spotify, 'fa-brands fa-spotify', 'Spotify', 'color:#1DB954;'),
    tpl(item.apple,   'fa-brands fa-apple',   'Apple Music', 'color:#fff;'),
    tpl(item.youtube, 'fa-brands fa-youtube', 'YouTube', 'color:#FF0000;'),
    tpl(item.deezer,  'fa-brands fa-deezer',  'Deezer', 'color:#ccc;'),
    tpl(item.amazon,  'fa-brands fa-amazon',  'Amazon Music', 'color:#FF9900;'),
    tpl(item.tidal,   'fa-solid fa-music',    'Tidal', 'color:#00ffff;')
  ].join('');
}

/* === Player propio (solo con preview) === */
let progressRAF = null;

function initPlayerFor(item){
  pTitle.textContent = item.title || 'Track';
  pArtist.textContent = 'J-Tenshi';
  renderPlatformsFor(item);

  // reset UI
  audioEl.src = '';
  if (progressRAF) cancelAnimationFrame(progressRAF);
  barFill.style.width = '0%';
  pTime.textContent = '0:00';
  btnPlay.innerHTML = `<i class="fa-solid fa-play"></i>`;

  if (item.preview) {
    audioEl.src = item.preview;
    pNote.textContent = 'Preview local (demo).';
  } else {
    pNote.textContent = 'Sin preview. Agrega “preview” (mp3/ogg) en data/songs.json para reproducir aquí.';
  }
}

function secToMMSS(s){
  const m = Math.floor(s/60) || 0, ss = Math.floor(s%60) || 0;
  return `${m}:${String(ss).padStart(2,'0')}`;
}

btnPlay.addEventListener('click', () => {
  if (!audioEl.src) return; // sin preview
  if (audioEl.paused) {
    audioEl.play().catch(()=>{});
  } else {
    audioEl.pause();
  }
});

audioEl.addEventListener('play', () => { btnPlay.innerHTML = `<i class="fa-solid fa-pause"></i>`; loopProgress(); });
audioEl.addEventListener('pause', () => { btnPlay.innerHTML = `<i class="fa-solid fa-play"></i>`; if(progressRAF) cancelAnimationFrame(progressRAF); });
audioEl.addEventListener('ended', () => { btnPlay.innerHTML = `<i class="fa-solid fa-play"></i>`; });

function loopProgress(){
  const dur = audioEl.duration || 0;
  const cur = audioEl.currentTime || 0;
  if (dur > 0) barFill.style.width = `${(cur/dur)*100}%`;
  pTime.textContent = `${secToMMSS(cur)}`;
  progressRAF = requestAnimationFrame(loopProgress);
}

/* === Modal open/close === */
function closeModal(){
  modal.classList.remove('open');
  audioEl.pause();
  HARD_LOCK.disable();
}

function openModal(item){
  mTitle.textContent = item.title || 'Track';
  mCover.style.backgroundImage = `url('${item.cover || ''}')`;
  initPlayerFor(item);
  modal.classList.add('open');
  HARD_LOCK.enable();
}

/* ===== init: carga -> oEmbed -> render ===== */
(async ()=>{
  await loadItems();
  await hydrateAll(ITEMS);
  render();
})();
</script>
</body>
</html>
