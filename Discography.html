<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tenshi — Discography</title>
<style>
  :root { color-scheme: dark; }
  *{box-sizing:border-box}
  body{
    margin:0; background:#0b0b0b; color:#eee;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  a{ color:inherit; text-decoration:none; }

  .hero{
    max-width:980px; margin:48px auto 10px; padding:0 16px; text-align:center;
  }
  .title{ font-size:34px; font-weight:900; letter-spacing:.5px; margin:16px 0 4px; }
  .subtitle{ opacity:.7; font-size:12px; letter-spacing:.25em; }

  .filters{
    display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
    margin:16px auto 26px;
  }
  .chip{
    border:1px solid #2a2a2a; background:#121212; color:#dfe6eb;
    padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
  }
  .chip.active{ border-color:#ffcc70; color:#111; background:#ffcc70; }

  .grid{
    max-width:980px; margin:0 auto 80px; padding:0 16px;
    display:grid; grid-template-columns: repeat(3, 1fr); gap:28px 24px;
  }
  @media (max-width:900px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:580px){ .grid{ grid-template-columns: 1fr; } }

  .card{
    background:#111; border:1px solid #222; border-radius:12px; overflow:hidden;
    box-shadow:0 16px 36px rgba(0,0,0,.45);
    transition:transform .15s ease, box-shadow .15s ease;
    cursor:pointer;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 22px 50px rgba(0,0,0,.6); }
  .thumb{
    width:100%; aspect-ratio:1 / 1; background:#0e0e0e center/cover no-repeat;
  }
  .meta{ padding:10px 12px 12px; text-align:center; }
  .date{ opacity:.6; font-size:10px; margin-bottom:6px; }
  .name{ font-size:13px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .modal{
    position:fixed; inset:0; display:none; place-items:center;
    background:rgba(0,0,0,.65); z-index:9999; padding:20px;
  }
  .modal.open{ display:grid; }
  .sheet{
    width:min(980px, 96vw); background:#0f0f0f; border:1px solid #222; border-radius:14px;
    box-shadow:0 30px 80px rgba(0,0,0,.75); overflow:hidden;
    animation:pop .12s ease-out;
  }
  @keyframes pop { from{ transform:scale(.98); opacity:.9 } to{ transform:scale(1); opacity:1 } }

  .sheet-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid #202020; background:#111;
  }
  .sheet-title{ font-weight:900; font-size:16px }
  .close{ border:none; border-radius:8px; background:#222; color:#eee; padding:6px 10px; cursor:pointer; }
  .close:hover{ background:#333; }
  .sheet-body{
    display:grid; grid-template-columns: 1.05fr 1fr; gap:16px; padding:16px;
  }
  @media (max-width:820px){ .sheet-body{ grid-template-columns: 1fr; } }

  .cover{
    width:100%; aspect-ratio:1/1; border-radius:10px; border:1px solid #222;
    background:#0d0d0d center/cover no-repeat;
  }
  .player{
    background:#111; border:1px solid #222; border-radius:12px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  .btn{
    border:none; border-radius:10px; background:#ffcc70; color:#111; padding:8px 12px; cursor:pointer;
    font-weight:700; width:max-content;
  }
  .note{ font-size:12px; opacity:.7; }
</style>
</head>
<body>

  <header class="hero">
    <div class="title">DISCOGRAPHY</div>
    <div class="subtitle">ディスコグラフィー</div>
  </header>

  <nav class="filters" id="filters">
    <button class="chip active" data-type="all">ALL</button>
    <button class="chip" data-type="single">SINGLE</button>
    <button class="chip" data-type="ep">EP</button>
    <button class="chip" data-type="album">ALBUM</button>
  </nav>

  <main class="grid" id="grid"></main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-head">
        <div class="sheet-title" id="mTitle">Track</div>
        <button class="close" id="btnClose">✕</button>
      </div>
      <div class="sheet-body">
        <div class="cover" id="mCover"></div>
        <div class="player" id="mPlayer"></div>
      </div>
    </div>
  </div>

<script>
/* ========= ITEMS: tus 5 pistas de Spotify =========
   Si omites "cover" o "title", se rellenan con el oEmbed de Spotify. */
const ITEMS = [
  { title: "", type:"single", date:"2025-01-01",
    spotify:"https://open.spotify.com/intl-es/track/2ns57MfTr1lBbiZ7IBXDFL?si=0363d843b89f4219" },
  { title: "", type:"single", date:"2025-01-15",
    spotify:"https://open.spotify.com/intl-es/track/3yS5cDr0hdMIk9nFvVMUlV?si=b1de99a203ed409c" },
  { title: "", type:"single", date:"2025-02-01",
    spotify:"https://open.spotify.com/intl-es/track/5OzpWTySMn0qsKswFF8jQo?si=096c0f70db84414a" },
  { title: "", type:"single", date:"2025-02-15",
    spotify:"https://open.spotify.com/intl-es/track/0gt5BKcHl70ZTWBclypMaB?si=5a320f27666d4184" },
  { title: "", type:"single", date:"2025-03-01",
    spotify:"https://open.spotify.com/intl-es/track/4kt26B0dFUYfiCMC1LJd1j?si=3496030443fd44b4" }
];

/* ========= Helpers ========= */
const grid    = document.getElementById('grid');
const filters = document.getElementById('filters');
const modal   = document.getElementById('modal');
const mTitle  = document.getElementById('mTitle');
const mCover  = document.getElementById('mCover');
const mPlayer = document.getElementById('mPlayer');
document.getElementById('btnClose').onclick = closeModal;
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

let currentType = 'all';

function formatDate(s){
  if(!s) return '';
  try{
    const d = new Date(s);
    return d.toLocaleDateString('es-CL', { year:'numeric', month:'short', day:'2-digit' });
  }catch{ return s; }
}
function trackIdFromUrl(url){
  const m = String(url).match(/^https?:\/\/open\.spotify\.com\/(?:intl-[^/]+\/)?track\/([A-Za-z0-9]+)(?:\?.*)?$/);
  return m ? m[1] : null;
}

/* === Traer carátula y título desde Spotify oEmbed (sin token) === */
async function hydrateFromOEmbed(item){
  if(!item.spotify) return item;
  const url = encodeURIComponent(item.spotify);
  const oembedURL = `https://open.spotify.com/oembed?url=${url}&maxwidth=640`;
  try{
    const res = await fetch(oembedURL, { mode: 'cors', cache:'no-store' });
    if(!res.ok) throw new Error('oEmbed error');
    const data = await res.json();
    // data.thumbnail_url, data.title
    if(!item.cover && data.thumbnail_url) item.cover = data.thumbnail_url;
    if(!item.title && data.title) item.title = data.title;
  }catch(e){
    // si oEmbed falla, seguimos con lo que haya
    // console.warn('oEmbed falló:', e);
  }
  return item;
}

async function hydrateAll(items){
  const jobs = items.map(it => hydrateFromOEmbed(it));
  await Promise.allSettled(jobs);
}

function render(){
  grid.innerHTML = '';
  ITEMS.filter(it => currentType==='all' ? true : it.type===currentType)
       .forEach((it) => {
         const card = document.createElement('div');
         card.className = 'card';
         const cover = it.cover || 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=800&auto=format&fit=crop';
         const name  = it.title || 'Track';
         card.innerHTML = `
           <div class="thumb" style="background-image:url('${cover}')"></div>
           <div class="meta">
             <div class="date">${formatDate(it.date)}</div>
             <div class="name" title="${name}">${name}</div>
           </div>
         `;
         card.addEventListener('click', () => openModal(it));
         grid.appendChild(card);
       });
}

filters.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip'); if(!btn) return;
  filters.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  currentType = btn.dataset.type || 'all';
  render();
});

function closeModal(){
  modal.classList.remove('open');
  mPlayer.innerHTML = '';
}

function openModal(item){
  mTitle.textContent = item.title || 'Track';
  mCover.style.backgroundImage = `url('${item.cover || ''}')`;
  mPlayer.innerHTML = '';

  const id = trackIdFromUrl(item.spotify || '');
  if(!id){
    mPlayer.innerHTML = `<div class="note">Esta tarjeta no tiene un link de <b>pista</b> de Spotify válido.</div>`;
  }else{
    const src = `https://open.spotify.com/embed/track/${id}?utm_source=generator&theme=0`;
    mPlayer.innerHTML = `
      <iframe style="border-radius:12px" src="${src}" width="100%" height="152"
        frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"></iframe>
      <button class="btn" onclick="window.open('${item.spotify}','_blank')">Abrir en Spotify</button>
      <div class="note">Reproductor oficial de Spotify (una sola canción).</div>
    `;
  }
  modal.classList.add('open');
}

/* init:
   1) completamos carátulas/títulos con oEmbed
   2) renderizamos grid */
(async ()=>{
  await hydrateAll(ITEMS);
  render();
})();
</script>
</body>
</html>
