<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editor de catálogo (News / Videos / Discografía / Banners)</title>
<style>
  :root { --bg:#0b0f14; --panel:#11161b; --ink:#e9eef3; --mut:#9fb0bf; --bd:#1d2a33; --acc:#ffcc70; }
  * { box-sizing: border-box }
  body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui,Segoe UI,Arial,sans-serif; }
  header { position:sticky; top:0; z-index:5; background:#0b1217; border-bottom:1px solid var(--bd); padding:12px 16px; display:flex; align-items:center; justify-content:space-between }
  header h1 { font-size:16px; margin:0; letter-spacing:.3px }
  header .actions { display:flex; gap:8px; flex-wrap:wrap }
  .btn { background:var(--acc); color:#222; border:none; border-radius:10px; padding:8px 12px; cursor:pointer }
  .btn.ghost { background:#162029; color:var(--ink); border:1px solid var(--bd) }
  .btn:disabled { opacity:.5; cursor:not-allowed }
  main { max-width:1100px; margin:20px auto; padding:0 16px; display:grid; gap:16px }
  .card { background:var(--panel); border:1px solid var(--bd); border-radius:14px; padding:14px }
  h2 { font-size:15px; margin:0 0 12px; color:#f7e2a6; letter-spacing:.3px }
  .row { display:grid; gap:10px; margin:10px 0 }
  label { font-size:13px; color:var(--mut) }
  input[type="text"] { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--bd); background:#0f151b; color:var(--ink) }
  table { width:100%; border-collapse: collapse; border:1px solid var(--bd); border-radius:12px; overflow:hidden; background:#0d141a }
  th, td { padding:10px; border-bottom:1px solid var(--bd); text-align:left; font-size:14px }
  th { background:#0f1a22; color:#cfe0ee; font-weight:600 }
  tr:hover td { background:#0e161d }
  .t-actions { display:flex; gap:6px; flex-wrap:wrap }
  .tiny { padding:6px 8px; font-size:12px; border-radius:8px }
  .mut { color:var(--mut) }
  .hl { color:#f7e2a6; font-weight:600 }
  .two { display:grid; gap:10px; grid-template-columns: 1fr 1fr }
  @media (max-width:800px){ .two { grid-template-columns: 1fr } }
</style>
</head>
<body>
<header>
  <h1>Editor de catálogo</h1>
  <div class="actions">
    <button id="btnLoad" class="btn ghost">Recargar JSON</button>
    <button id="btnCopy" class="btn ghost">Copiar JSON</button>
    <button id="btnDownload" class="btn">Descargar JSON</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>Banners</h2>
    <div class="two">
      <div class="row">
        <label>banner_principal</label>
        <input type="text" id="banner_principal">
      </div>
      <div class="row">
        <label>banner_discografia</label>
        <input type="text" id="banner_discografia">
      </div>
      <div class="row">
        <label>banner_videos</label>
        <input type="text" id="banner_videos">
      </div>
    </div>
  </section>

  <section class="card">
    <h2>News <span class="mut">(N1…N5, clic en “↑/↓” para reordenar)</span></h2>
    <div style="margin-bottom:10px;">
      <button class="btn tiny" id="addNews">+ Agregar noticia</button>
      <span class="mut">imagen / destino / título</span>
    </div>
    <table id="newsTable">
      <thead>
        <tr><th>#</th><th>Imagen</th><th>Destino</th><th>Título</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Videos</h2>
    <div style="margin-bottom:10px;">
      <button class="btn tiny" id="addVideo">+ Agregar video</button>
      <span class="mut">URL (usa formato <span class="hl">/embed/...</span>)</span>
    </div>
    <table id="videoTable">
      <thead><tr><th>#</th><th>URL</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Discografía (portadas)</h2>
    <div style="margin-bottom:10px;">
      <button class="btn tiny" id="addCover">+ Agregar portada</button>
    </div>
    <table id="coverTable">
      <thead><tr><th>#</th><th>URL portada</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
const PATH = 'data/catalogo.json'; // ajusta si lo tienes en otro lugar

let state = {
  banner_principal: '',
  banner_discografia: '',
  banner_videos: '',
  news: {},              // { n1:{imagen,...}, n2:{...}, ... }
  videos: [],            // [ {url:"..."}, ... ]
  discografia: { portadas: [] }
};

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* --------- CARGA --------- */
async function loadJson() {
  const res = await fetch(PATH + '?' + Date.now(), { cache:'no-store' });
  const data = await res.json();
  // normalizar
  state.banner_principal   = data.banner_principal || '';
  state.banner_discografia = data.banner_discografia || '';
  state.banner_videos      = data.banner_videos || '';
  state.news               = data.news || {};
  state.videos             = Array.isArray(data.videos) ? data.videos : [];
  state.discografia        = data.discografia || { portadas: [] };
  renderAll();
}

function renderAll(){
  // banners
  $('#banner_principal').value = state.banner_principal;
  $('#banner_discografia').value = state.banner_discografia;
  $('#banner_videos').value = state.banner_videos;

  // news
  const tbody = $('#newsTable tbody');
  tbody.innerHTML = '';
  const keys = Object.keys(state.news).sort((a,b)=>Number(a.slice(1))-Number(b.slice(1)));
  keys.forEach((k, idx) => {
    const n = state.news[k] || {};
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${k.toUpperCase()}</td>
      <td><input type="text" value="${n.imagen || ''}" data-field="imagen"></td>
      <td><input type="text" value="${n.destino || ''}" data-field="destino" placeholder="discografia | movie | news | gallery | url"></td>
      <td><input type="text" value="${n.titulo || ''}" data-field="titulo"></td>
      <td class="t-actions">
        <button class="btn tiny ghost" data-act="up">↑</button>
        <button class="btn tiny ghost" data-act="down">↓</button>
        <button class="btn tiny" data-act="del">Borrar</button>
      </td>
    `;
    // inputs
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', e=>{
        state.news[k][e.target.dataset.field] = e.target.value.trim();
      });
    });
    // acciones
    tr.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(btn.dataset.act==='del'){
          delete state.news[k];
          renumerarNews();
          renderAll();
        }
        if(btn.dataset.act==='up'){ moverNews(idx, -1); }
        if(btn.dataset.act==='down'){ moverNews(idx, +1); }
      });
    });
    tbody.appendChild(tr);
  });

  // videos
  const vbody = $('#videoTable tbody');
  vbody.innerHTML = '';
  state.videos.forEach((v, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="text" value="${v.url || ''}"></td>
      <td class="t-actions">
        <button class="btn tiny ghost" data-act="up">↑</button>
        <button class="btn tiny ghost" data-act="down">↓</button>
        <button class="btn tiny" data-act="del">Borrar</button>
      </td>
    `;
    tr.querySelector('input').addEventListener('input', e=>{
      state.videos[i].url = e.target.value.trim();
    });
    tr.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(btn.dataset.act==='del'){ state.videos.splice(i,1); renderAll(); }
        if(btn.dataset.act==='up'){ moverGeneric(state.videos, i, -1); renderAll(); }
        if(btn.dataset.act==='down'){ moverGeneric(state.videos, i, +1); renderAll(); }
      });
    });
    vbody.appendChild(tr);
  });

  // portadas
  const cbody = $('#coverTable tbody');
  cbody.innerHTML = '';
  (state.discografia.portadas||[]).forEach((u, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="text" value="${u}"></td>
      <td class="t-actions">
        <button class="btn tiny ghost" data-act="up">↑</button>
        <button class="btn tiny ghost" data-act="down">↓</button>
        <button class="btn tiny" data-act="del">Borrar</button>
      </td>
    `;
    tr.querySelector('input').addEventListener('input', e=>{
      state.discografia.portadas[i] = e.target.value.trim();
    });
    tr.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(btn.dataset.act==='del'){ state.discografia.portadas.splice(i,1); renderAll(); }
        if(btn.dataset.act==='up'){ moverGeneric(state.discografia.portadas, i, -1); renderAll(); }
        if(btn.dataset.act==='down'){ moverGeneric(state.discografia.portadas, i, +1); renderAll(); }
      });
    });
    cbody.appendChild(tr);
  });
}

/* --------- Helpers reordenar --------- */
function moverGeneric(arr, i, dir){
  const j = i + dir;
  if(j<0 || j>=arr.length) return;
  [arr[i], arr[j]] = [arr[j], arr[i]];
}
function moverNews(i, dir){
  const keys = Object.keys(state.news).sort((a,b)=>Number(a.slice(1))-Number(b.slice(1)));
  const j = i + dir;
  if(j<0 || j>=keys.length) return;
  [state.news[keys[i]], state.news[keys[j]]] = [state.news[keys[j]], state.news[keys[i]]];
  // renumeramos para mantener n1..n5 ordenados
  const sorted = Object.values(state.news);
  state.news = {};
  sorted.forEach((item, idx)=>{ state.news['n'+(idx+1)] = item; });
  renderAll();
}
function renumerarNews(){
  const arr = Object.values(state.news);
  state.news = {};
  arr.forEach((item, idx)=>{ state.news['n'+(idx+1)] = item; });
}

/* --------- Acciones UI --------- */
$('#banner_principal').addEventListener('input', e=> state.banner_principal = e.target.value.trim());
$('#banner_discografia').addEventListener('input', e=> state.banner_discografia = e.target.value.trim());
$('#banner_videos').addEventListener('input', e=> state.banner_videos = e.target.value.trim());

$('#addNews').onclick = ()=>{
  const count = Object.keys(state.news).length;
  state.news['n'+(count+1)] = { imagen:'', destino:'news', titulo:'' };
  renderAll();
};
$('#addVideo').onclick = ()=>{ state.videos.push({ url:'' }); renderAll(); };
$('#addCover').onclick = ()=>{ (state.discografia.portadas ||= []).push(''); renderAll(); };

$('#btnLoad').onclick = loadJson;

$('#btnCopy').onclick = async()=>{
  const out = buildJson();
  try{
    await navigator.clipboard.writeText(out);
    $('#btnCopy').textContent = '¡Copiado!';
    setTimeout(()=>$('#btnCopy').textContent='Copiar JSON', 900);
  }catch(e){
    alert('No se pudo copiar: ' + e.message);
  }
};

$('#btnDownload').onclick = ()=>{
  const out = buildJson();
  const blob = new Blob([out], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'catalogo.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

function buildJson(){
  // construir objeto final respetando orden n1..nN
  const newsOrdered = {};
  Object.keys(state.news).sort((a,b)=>Number(a.slice(1))-Number(b.slice(1)))
    .forEach(k=> newsOrdered[k]=state.news[k]);
  const obj = {
    banner_principal: state.banner_principal,
    banner_discografia: state.banner_discografia,
    banner_videos: state.banner_videos,
    news: newsOrdered,
    videos: state.videos,
    discografia: { portadas: state.discografia.portadas || [] }
  };
  return JSON.stringify(obj, null, 2);
}

// arranque
loadJson();
</script>
</body>
</html>
