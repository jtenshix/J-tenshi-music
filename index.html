const cardOriginal = document.getElementById('cardOriginal');
const cardFantasmaWrapper = document.getElementById('cardFantasmaWrapper');
const flipBtn = document.getElementById('flipBtn');
let isFlippedOriginal = false;
let rotationXOriginal = 0, rotationYOriginal = 0;
let isDraggingOriginal = false;
let startXOriginal = 0, startYOriginal = 0;
let currentXOriginal = 0, currentYOriginal = 0;
let dragStartTimeOriginal;
let isAnimating = false;

function updateCardRotationOriginal() {
    cardOriginal.style.transform = `rotateX(${rotationXOriginal}deg) rotateY(${rotationYOriginal}deg)`;
}

function startDragOriginal(e) {
    if (!isAnimating) {
        isDraggingOriginal = true;
        startXOriginal = e.touches ? e.touches[0].clientX : e.clientX;
        startYOriginal = e.touches ? e.touches[0].clientY : e.clientY;
        dragStartTimeOriginal = Date.now();
        cardOriginal.style.transition = "transform 0.1s ease-out, opacity 0.2s ease-in-out";
        currentXOriginal = startXOriginal;
        currentYOriginal = startYOriginal;
    }
}

function dragMoveOriginal(e) {
    if (isDraggingOriginal && !isAnimating) {
        let x = e.touches ? e.touches[0].clientX : e.clientX;
        let y = e.touches ? e.touches[0].clientY : e.clientY;

        let deltaY = y - startYOriginal;
        let deltaX = x - startXOriginal;

        rotationXOriginal -= deltaY * 0.2;
        rotationYOriginal += deltaX * 0.2;

        updateCardRotationOriginal();

        startYOriginal = y;
        startXOriginal = x;
        currentYOriginal = y;
        currentXOriginal = x;
    }
}

function stopDragOriginal() {
    if (isDraggingOriginal && !isAnimating) {
        isDraggingOriginal = false;
        cardOriginal.style.transition = "transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.2s ease-in-out";

        const animationDuration = 300;
        let velocityY = (currentYOriginal - startYOriginal) / (Date.now() - dragStartTimeOriginal);
        let velocityX = (currentXOriginal - startXOriginal) / (Date.now() - dragStartTimeOriginal);

        const inertiaMultiplier = 0.2;
        rotationXOriginal -= velocityY * inertiaMultiplier;
        rotationYOriginal += velocityX * inertiaMultiplier;

        rotationXOriginal = Math.round(rotationXOriginal / 360) * 360;
        rotationYOriginal = Math.round(rotationYOriginal / 360) * 360;

        updateCardRotationOriginal();

        setTimeout(() => {
            cardOriginal.style.transition = "transform 0.3s ease-out, opacity 0.2s ease-in-out";
        }, animationDuration);
    }
}

flipBtn.addEventListener('click', () => {
    if (!isAnimating) {
        isAnimating = true;

        // 1. Desaparecer la carta original
        cardOriginal.style.opacity = 0;

        // 2. Aparecer la carta fantasma (roja y blanca) y hacer el efecto de volteo
        cardFantasmaWrapper.classList.add('visible');
        void cardFantasmaWrapper.offsetWidth; // Forzar reflow
        cardFantasmaWrapper.classList.add('flipped'); // AÃ±adir la clase 'flipped' y dejarla

        // 3. Ya no se espera para hacerla invisible ni se resetea la clase 'flipped'

        // 4. Ya no se voltea ni se hace visible la original inmediatamente

        isAnimating = false; // Permitir futuras interacciones
    }
});

document.addEventListener('touchstart', startDragOriginal);
document.addEventListener('touchmove', dragMoveOriginal);
document.addEventListener('touchend', stopDragOriginal);
